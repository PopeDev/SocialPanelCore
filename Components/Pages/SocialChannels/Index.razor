@page "/social-channels"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Web
@using SocialPanelCore.Domain.Interfaces
@using SocialPanelCore.Domain.Entities
@using SocialPanelCore.Domain.Enums
@using SocialPanelCore.Components.Shared.Dialogs
@inject IAccountService AccountService
@inject ISocialChannelConfigService SocialChannelConfigService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Configuracion de Redes Sociales</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Configuracion de Redes Sociales</MudText>

<MudGrid>
    <!-- Selector de Cuenta -->
    <MudItem xs="12">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudSelect T="Guid" Label="Seleccionar Cuenta"
                           Value="_selectedAccountId"
                           ValueChanged="OnAccountChanged"
                           AdornmentIcon="@Icons.Material.Filled.Business"
                           Adornment="Adornment.Start">
                    @foreach (var account in _accounts)
                    {
                        <MudSelectItem Value="@account.Id">@account.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudCardContent>
        </MudCard>
    </MudItem>

    @if (_selectedAccountId != Guid.Empty)
    {
        <!-- Tarjetas de Redes Sociales -->
        @foreach (var network in Enum.GetValues<NetworkType>())
        {
            var channel = _channels.FirstOrDefault(c => c.NetworkType == network);
            var isConfigured = channel != null;
            var isHealthy = channel?.HealthStatus == HealthStatus.OK;
            var authMethod = GetAuthMethodForNetwork(network);

            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <div class="d-flex justify-space-between align-center">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@GetNetworkIcon(network)" Color="@GetNetworkColor(network)" Class="mr-2" />
                                    <MudText Typo="Typo.h6">@GetNetworkName(network)</MudText>
                                </div>
                                @if (isConfigured)
                                {
                                    <MudIcon Icon="@(isHealthy ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)"
                                             Color="@(isHealthy ? Color.Success : Color.Error)" />
                                }
                            </div>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (isConfigured && channel != null)
                        {
                            <MudText Typo="Typo.body2" Class="mb-2">
                                <strong>Estado:</strong>
                                <MudChip T="string" Size="Size.Small"
                                         Color="@(isHealthy ? Color.Success : Color.Error)"
                                         Class="ml-2">
                                    @GetHealthStatusName(channel.HealthStatus)
                                </MudChip>
                            </MudText>

                            <MudText Typo="Typo.body2" Class="mb-2">
                                <strong>Metodo:</strong> @GetAuthMethodName(channel.AuthMethod)
                            </MudText>

                            @if (!string.IsNullOrEmpty(channel.Handle))
                            {
                                <MudText Typo="Typo.body2" Class="mb-2">
                                    <strong>Handle:</strong> @@@channel.Handle
                                </MudText>
                            }

                            <MudText Typo="Typo.body2" Class="mb-2">
                                <strong>Habilitado:</strong>
                                <MudSwitch T="bool" Value="@channel.IsEnabled"
                                           ValueChanged="@((bool v) => ToggleChannel(channel))"
                                           Color="Color.Primary"
                                           Size="Size.Small" />
                            </MudText>

                            <MudText Typo="Typo.body2" Class="mb-2">
                                <strong>Permitir Medios:</strong>
                                <MudSwitch T="bool" Value="@channel.AllowMedia"
                                           ValueChanged="@((bool v) => ToggleAllowMedia(channel, v))"
                                           Color="Color.Info"
                                           Size="Size.Small" />
                            </MudText>

                            @if (channel.TokenExpiresAt.HasValue)
                            {
                                var daysToExpire = (channel.TokenExpiresAt.Value - DateTime.UtcNow).Days;
                                <MudAlert Severity="@(daysToExpire < 7 ? Severity.Warning : Severity.Info)"
                                          Dense="true"
                                          Class="mt-2">
                                    Token expira en @daysToExpire dias
                                </MudAlert>
                            }

                            @if (!string.IsNullOrEmpty(channel.LastErrorMessage))
                            {
                                <MudAlert Severity="Severity.Error" Dense="true" Class="mt-2">
                                    @channel.LastErrorMessage
                                </MudAlert>
                            }
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Dense="true">
                                No configurado
                            </MudAlert>
                            <MudText Typo="Typo.caption" Class="mt-2">
                                Configura mediante @GetAuthMethodName(authMethod)
                            </MudText>
                        }
                    </MudCardContent>
                    <MudCardActions>
                        @if (isConfigured && channel != null)
                        {
                            <MudButton Size="Size.Small"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Settings"
                                       OnClick="@(() => ConfigureNetwork(network, channel))">
                                Reconfigurar
                            </MudButton>
                            <MudButton Size="Size.Small"
                                       Color="Color.Error"
                                       StartIcon="@Icons.Material.Filled.Delete"
                                       OnClick="@(() => DeleteChannel(channel))">
                                Eliminar
                            </MudButton>
                        }
                        else
                        {
                            <MudButton Size="Size.Small"
                                       Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Link"
                                       OnClick="@(() => ConfigureNetwork(network, null))">
                                @(authMethod == AuthMethod.OAuth ? "Conectar OAuth" : "Configurar API")
                            </MudButton>
                        }
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    }
    else
    {
        <MudItem xs="12">
            <MudAlert Severity="Severity.Info">
                Seleccione una cuenta para gestionar sus redes sociales.
            </MudAlert>
        </MudItem>
    }
</MudGrid>

@code {
    private List<Account> _accounts = new();
    private List<SocialChannelConfig> _channels = new();
    private Guid _selectedAccountId = Guid.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadAccounts();
    }

    private async Task LoadAccounts()
    {
        _accounts = (await AccountService.GetAllAccountsAsync()).ToList();
        if (_accounts.Any())
        {
            _selectedAccountId = _accounts.First().Id;
            await LoadChannels();
        }
    }

    private async Task OnAccountChanged(Guid accountId)
    {
        _selectedAccountId = accountId;
        await LoadChannels();
    }

    private async Task LoadChannels()
    {
        if (_selectedAccountId == Guid.Empty) return;
        _channels = (await SocialChannelConfigService.GetChannelConfigsByAccountAsync(_selectedAccountId)).ToList();
    }

    private async Task ToggleChannel(SocialChannelConfig channel)
    {
        try
        {
            if (channel.IsEnabled)
            {
                await SocialChannelConfigService.DisableChannelAsync(channel.Id);
                Snackbar.Add($"Canal deshabilitado", Severity.Success);
            }
            else
            {
                await SocialChannelConfigService.EnableChannelAsync(channel.Id);
                Snackbar.Add($"Canal habilitado", Severity.Success);
            }
            await LoadChannels();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task ToggleAllowMedia(SocialChannelConfig channel, bool value)
    {
        try
        {
            await SocialChannelConfigService.UpdateAllowMediaAsync(channel.Id, value);
            channel.AllowMedia = value;
            Snackbar.Add($"Configuración de medios actualizada para {GetNetworkName(channel.NetworkType)}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task ConfigureNetwork(NetworkType network, SocialChannelConfig? existing)
    {
        var authMethod = GetAuthMethodForNetwork(network);

        DialogResult? result;

        if (authMethod == AuthMethod.ApiKey)
        {
            // Usar dialogo de API Key (X/Twitter)
            var parameters = new DialogParameters<ConfigureXCredentialsDialog>
            {
                { x => x.AccountId, _selectedAccountId },
                { x => x.ExistingConfigId, existing?.Id }
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Small,
                FullWidth = true,
                CloseButton = true
            };

            var dialog = await DialogService.ShowAsync<ConfigureXCredentialsDialog>(
                $"Configurar {GetNetworkName(network)}",
                parameters,
                options);

            result = await dialog.Result;
        }
        else
        {
            // Usar dialogo OAuth
            var parameters = new DialogParameters<ConfigureOAuthDialog>
            {
                { x => x.AccountId, _selectedAccountId },
                { x => x.NetworkType, network },
                { x => x.ExistingConfigId, existing?.Id }
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Small,
                FullWidth = true,
                CloseButton = true
            };

            var dialog = await DialogService.ShowAsync<ConfigureOAuthDialog>(
                $"Conectar {GetNetworkName(network)}",
                parameters,
                options);

            result = await dialog.Result;
        }

        if (result != null && !result.Canceled)
        {
            await LoadChannels();
        }
    }

    private async Task DeleteChannel(SocialChannelConfig channel)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.ContentText, $"¿Estas seguro de eliminar la configuracion de {GetNetworkName(channel.NetworkType)}?" },
            { x => x.ButtonText, "Eliminar" },
            { x => x.Color, Color.Error }
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Confirmar eliminacion", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            try
            {
                await SocialChannelConfigService.DeleteChannelAsync(channel.Id);
                Snackbar.Add("Configuracion eliminada", Severity.Success);
                await LoadChannels();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private AuthMethod GetAuthMethodForNetwork(NetworkType network) => network switch
    {
        NetworkType.X => AuthMethod.ApiKey,
        // Telegram tambien usaria ApiKey cuando se agregue
        _ => AuthMethod.OAuth
    };

    private string GetNetworkName(NetworkType network) => network switch
    {
        NetworkType.Facebook => "Facebook",
        NetworkType.Instagram => "Instagram",
        NetworkType.TikTok => "TikTok",
        NetworkType.X => "X (Twitter)",
        NetworkType.YouTube => "YouTube",
        NetworkType.LinkedIn => "LinkedIn",
        _ => network.ToString()
    };

    private string GetNetworkIcon(NetworkType network) => network switch
    {
        NetworkType.Facebook => Icons.Custom.Brands.Facebook,
        NetworkType.Instagram => Icons.Custom.Brands.Instagram,
        NetworkType.TikTok => Icons.Custom.Brands.TikTok,
        NetworkType.X => Icons.Custom.Brands.Twitter,
        NetworkType.YouTube => Icons.Custom.Brands.YouTube,
        NetworkType.LinkedIn => Icons.Custom.Brands.LinkedIn,
        _ => Icons.Material.Filled.Share
    };

    private Color GetNetworkColor(NetworkType network) => network switch
    {
        NetworkType.Facebook => Color.Primary,
        NetworkType.Instagram => Color.Secondary,
        NetworkType.TikTok => Color.Dark,
        NetworkType.X => Color.Dark,
        NetworkType.YouTube => Color.Error,
        NetworkType.LinkedIn => Color.Info,
        _ => Color.Default
    };

    private string GetHealthStatusName(HealthStatus status) => status switch
    {
        HealthStatus.OK => "Conectado",
        HealthStatus.KO => "Error",
        _ => status.ToString()
    };

    private string GetAuthMethodName(AuthMethod method) => method switch
    {
        AuthMethod.OAuth => "OAuth",
        AuthMethod.ApiKey => "API Key",
        _ => method.ToString()
    };
}
