@using SocialPanelCore.Domain.Enums
@using SocialPanelCore.Domain.Interfaces
@inject ISocialChannelConfigService SocialChannelConfigService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Custom.Brands.Twitter" Class="mr-2" />
            Configurar X (Twitter)
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.body2" Class="mb-4">
            Para conectar X (Twitter), necesitas obtener las credenciales desde el
            <MudLink Href="https://developer.twitter.com/en/portal/dashboard" Target="_blank">Portal de Desarrolladores de Twitter</MudLink>.
        </MudText>

        <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
            Asegurate de que tu aplicacion tenga permisos de lectura y escritura.
        </MudAlert>

        <MudTextField @bind-Value="_apiKey"
                      Label="API Key (Consumer Key)"
                      Variant="Variant.Outlined"
                      Required="true"
                      HelperText="La clave de API de tu aplicacion"
                      Class="mb-3" />

        <MudTextField @bind-Value="_apiSecret"
                      Label="API Secret (Consumer Secret)"
                      Variant="Variant.Outlined"
                      InputType="InputType.Password"
                      Required="true"
                      HelperText="El secreto de API de tu aplicacion"
                      Class="mb-3" />

        <MudTextField @bind-Value="_accessToken"
                      Label="Access Token"
                      Variant="Variant.Outlined"
                      Required="true"
                      HelperText="Token de acceso de tu cuenta"
                      Class="mb-3" />

        <MudTextField @bind-Value="_accessTokenSecret"
                      Label="Access Token Secret"
                      Variant="Variant.Outlined"
                      InputType="InputType.Password"
                      Required="true"
                      HelperText="Secreto del token de acceso"
                      Class="mb-3" />

        <MudTextField @bind-Value="_handle"
                      Label="Handle de usuario (opcional)"
                      Variant="Variant.Outlined"
                      Placeholder="@usuario"
                      HelperText="Tu nombre de usuario en X (sin @)" />

        @if (_isLoading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mt-4" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mt-4">@_errorMessage</MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Disabled="_isLoading">Cancelar</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="SaveCredentials"
                   Disabled="@(!IsFormValid || _isLoading)">
            @if (_isLoading)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Guardar
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public Guid AccountId { get; set; }

    [Parameter]
    public Guid? ExistingConfigId { get; set; }

    private string _apiKey = string.Empty;
    private string _apiSecret = string.Empty;
    private string _accessToken = string.Empty;
    private string _accessTokenSecret = string.Empty;
    private string _handle = string.Empty;
    private bool _isLoading = false;
    private string? _errorMessage;

    private bool IsFormValid =>
        !string.IsNullOrWhiteSpace(_apiKey) &&
        !string.IsNullOrWhiteSpace(_apiSecret) &&
        !string.IsNullOrWhiteSpace(_accessToken) &&
        !string.IsNullOrWhiteSpace(_accessTokenSecret);

    private async Task SaveCredentials()
    {
        if (!IsFormValid) return;

        _isLoading = true;
        _errorMessage = null;

        try
        {
            if (ExistingConfigId.HasValue)
            {
                // Actualizar credenciales existentes
                await SocialChannelConfigService.UpdateApiKeyCredentialsAsync(
                    ExistingConfigId.Value,
                    _apiKey.Trim(),
                    _apiSecret.Trim(),
                    _accessToken.Trim(),
                    _accessTokenSecret.Trim());
            }
            else
            {
                // Crear nueva configuracion
                await SocialChannelConfigService.CreateChannelConfigWithApiKeyAsync(
                    AccountId,
                    NetworkType.X,
                    _apiKey.Trim(),
                    _apiSecret.Trim(),
                    _accessToken.Trim(),
                    _accessTokenSecret.Trim(),
                    string.IsNullOrWhiteSpace(_handle) ? null : _handle.Trim().TrimStart('@'));
            }

            Snackbar.Add("Credenciales de X guardadas correctamente", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al guardar: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void Cancel() => MudDialog.Close(DialogResult.Cancel());
}
